<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ê±´ê°• ìœ„í—˜ë„ ìê°€ì§„ë‹¨ í…ŒìŠ¤íŠ¸</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css">

<style>
  :root{
    --navy:#0b2340; --accent:#0f4c81; --card:#ffffffee; --muted:#6b7788;
    --good:#1fbf7b; --warn:#f6c85f; --bad:#ef5350;
    --maxw:980px; --glass: rgba(255,255,255,0.06);
  }
  *{box-sizing:border-box;font-family:"PretendardVariable","Noto Sans KR",system-ui,-apple-system}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071428,#0b2340);color:var(--navy)}
  .app{max-width:980px;margin:28px auto;padding:18px;display:grid;gap:16px}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 12px 40px rgba(2,8,23,0.55)}
  h1{margin:0 0 6px;color:var(--accent);font-size:20px}
  p.lead{margin:0 0 12px;color:#445;font-size:14px}
  label.block{display:block;margin:8px 0 6px;font-weight:700;color:var(--navy)}
  input[type="text"], input[type="number"], select, textarea {width:100%;padding:10px;border-radius:8px;border:1px solid #d6def4;background:white;outline:none}
  input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {box-shadow:0 6px 18px rgba(15,76,129,0.06);border-color:var(--accent)}
  .row{display:flex;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{background:linear-gradient(90deg,var(--accent),#235a9a);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
  .btn.secondary{background:#eef4fb;color:var(--navy);border:1px solid #d6e1f7}
  .muted{color:var(--muted);font-size:13px}
  .question{display:none}
  .question.active{display:block}
  .progress{height:10px;background:#eaf2ff;border-radius:8px;overflow:hidden;margin:12px 0}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#235a9a);transition:width .32s}
  .detail-card{background:#fbfeff;border:1px solid #e6efff;padding:12px;border-radius:10px;margin-bottom:12px}
  canvas{max-width:100%;height:240px}
  .small{font-size:13px;color:var(--muted)}
  .checkbox-row{display:flex;gap:12px;flex-wrap:wrap}
  .severity{display:inline-flex;gap:8px;align-items:center}
  .history-panel{background:#fbfdff;border:1px dashed #d6e1f4;padding:12px;border-radius:10px}
  .footer-note{font-size:12px;color:var(--muted);margin-top:10px}
  .center{display:flex;justify-content:center;align-items:center}
  @media(max-width:820px){.row{flex-direction:column}.grid2{grid-template-columns:1fr} .app{padding:12px}}

  /* custom, borrowed-looking checkbox button */
  .checkbtn{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;background:var(--glass);border:1px solid rgba(15,76,129,0.08);cursor:pointer;color:var(--navy);font-weight:700}
  .checkbtn input{display:none}
  .checkbtn.active{background:var(--accent);color:white;box-shadow:0 8px 24px rgba(11,36,64,0.18)}

  /* mascot: updated, cuter flat style */
  .mascot{width:82px;height:82px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(2,8,23,0.18)}
  .mascot svg{width:64px;height:64px}
  .mascotCaption{margin-top:10px;font-size:13px;color:var(--muted);text-align:center}

  .pager{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:12px}
  .meta{font-size:13px;color:var(--muted)}

  /* validation styles */
  .invalid { border-color:#ef6b6b !important; box-shadow:0 6px 18px rgba(239,107,107,0.08); animation: shake .36s; }
  @keyframes shake { 0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)} }

  /* subtle helper for invalid message */
  .invalid-note{color:#d14343;font-size:13px;margin-top:6px}

  /* ensure cards are not split across pages for print */
  @media print{
    body{background:white}
    .card{page-break-inside: avoid; -webkit-print-color-adjust: exact}
    button, .pager, .no-print { display:none !important; }
    .mascotCaption{display:none}
    canvas{max-height:220px !important}
  }
  @page{ margin: 10mm; }

  /* small responsive tweak for pdf slices */
  .report-wrap{padding:8px}
</style>
</head>
<body>
<div class="app">

  <!-- SURVEY CARD -->
  <section class="card" id="surveyCard">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h1>ğŸ©º ê±´ê°• ìœ„í—˜ë„ ìê°€ì§„ë‹¨</h1>
        <p class="lead">ì´ 11ë¬¸í•­ í…ŒìŠ¤íŠ¸ í›„ ìš”ì•½ ë° ìƒì„¸ ë¦¬í¬íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>
      </div>
      <div style="text-align:right">
        <div class="mascot" id="mascotSmall" title="ê±´ê°• í† ë¼">
          <!-- UPDATED: cuter flat rabbit face -->
          <svg id="mascotSmallSvg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="rabbit">
            <rect width="64" height="64" rx="12" fill="#ffffff"/>
            <!-- ears -->
            <path d="M20 8 q6 -6 12 0" fill="#fff" stroke="#0b2340" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M44 8 q-6 -6 -12 0" fill="#fff" stroke="#0b2340" stroke-width="1.5" stroke-linecap="round"/>
            <!-- rounded face, friendly eyes -->
            <ellipse cx="32" cy="38" rx="18" ry="14" fill="#fff" stroke="#0b2340" stroke-width="1.5"/>
            <circle cx="26" cy="34" r="3.2" fill="#0b2340"/>
            <circle cx="38" cy="34" r="3.2" fill="#0b2340"/>
            <!-- blushing cheeks -->
            <circle cx="22" cy="38" r="2.6" fill="#ffdede" opacity="0.9"/>
            <circle cx="42" cy="38" r="2.6" fill="#ffdede" opacity="0.9"/>
            <!-- gentle smile -->
            <path id="bunnyMouth" d="M28 44 q4 4 8 0" stroke="#0b2340" stroke-width="1.8" fill="none" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="mascotCaption" id="mascotCaption">í† ë¼ê°€ ê²°ê³¼ì— ë”°ë¼ í‘œì •ì„ ë°”ê¿‰ë‹ˆë‹¤ ğŸ°</div>
      </div>
    </div>

    <div class="progress"><i id="progressBar"></i></div>

    <form id="surveyForm" onsubmit="return false">
      <!-- IDENT -->
      <div class="question active" data-step="0" id="step0">
        <label class="block">ì´ë¦„ <span class="small" style="font-weight:600;color:var(--muted)">(í•„ìˆ˜)</span></label>
        <input type="text" id="name" placeholder="ì˜ˆ: ëª¨ì´" />
        <div class="invalid-note" id="note-step0" style="display:none">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        <div class="pager"><div class="meta">ì§ˆë¬¸ 1 / 11</div><div style="text-align:right"><button class="btn no-print" type="button" onclick="nextStep()">ì‹œì‘ â†’</button></div></div>
      </div>

      <!-- DEMO -->
      <div class="question" data-step="1" id="step1">
        <div class="row">
          <div style="flex:1"><label class="block">ì—°ë ¹ (ë§Œ) <span class="small">(í•„ìˆ˜)</span></label><input type="number" id="age" min="10" max="120" /></div>
          <div style="width:160px"><label class="block">ì„±ë³„ <span class="small">(í•„ìˆ˜)</span></label><select id="gender"><option value="">ì„ íƒ</option><option value="male">ë‚¨ì„±</option><option value="female">ì—¬ì„±</option><option value="na">ë°íˆê³  ì‹¶ì§€ ì•ŠìŒ</option></select></div>
        </div>
        <div class="invalid-note" id="note-step1" style="display:none">ì—°ë ¹ê³¼ ì„±ë³„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        <div class="pager"><div class="meta">ì§ˆë¬¸ 2 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- BMI -->
      <div class="question" data-step="2" id="step2">
        <div class="grid2"><div><label class="block">í‚¤ (cm) <span class="small">(í•„ìˆ˜)</span></label><input type="number" id="height" placeholder="ì˜ˆ: 170"></div><div><label class="block">ì²´ì¤‘ (kg) <span class="small">(í•„ìˆ˜)</span></label><input type="number" id="weight" placeholder="ì˜ˆ: 64"></div></div>
        <p id="bmiText" class="muted" style="margin-top:8px"></p>
        <div class="invalid-note" id="note-step2" style="display:none">í‚¤ì™€ ì²´ì¤‘ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        <div class="pager"><div class="meta">ì§ˆë¬¸ 3 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="handleBMIandNext()">ê³„ì‚° í›„ ë‹¤ìŒ</button></div></div>
      </div>

      <!-- FAMILY HISTORY -->
      <div class="question" data-step="3" id="step3">
        <label class="block">ê°€ì¡±ë ¥ (ì§ê³„ ê°€ì¡± â€” ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</label>
        <div class="checkbox-row" id="familyRow">
          <label class="checkbtn"><input type="checkbox" name="family" value="chd"> ê´€ìƒë™ë§¥ì§ˆí™˜(ì‹¬ê·¼ê²½ìƒ‰) </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="stroke"> ë‡Œì¡¸ì¤‘ </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="hypertension"> ê³ í˜ˆì•• </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="diabetes"> ì œ2í˜• ë‹¹ë‡¨ë³‘ </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="obesity"> ë¹„ë§Œ(ì¤‘ì¦) </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="hyperlipidemia"> ì´ìƒì§€ì§ˆí˜ˆì¦(ê³ ì§€í˜ˆì¦) </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="colon_cancer"> ëŒ€ì¥ì•” </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="breast_cancer"> ìœ ë°©ì•” </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="gastric_cancer"> ìœ„ì•” </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="liver_cancer"> ê°„ì•” </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="depression"> ìš°ìš¸ì¦/ì •ì‹ ê±´ê°•ì§ˆí™˜ </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="autoimmune"> ìê°€ë©´ì—­ì§ˆí™˜(ê°‘ìƒì„  í¬í•¨) </label>
          <label class="checkbtn"><input type="checkbox" name="family" value="none"> í•´ë‹¹ ì—†ìŒ</label>
        </div>
        <label class="block">ê¸°íƒ€ (ì„ íƒ)</label><input type="text" id="family_other" placeholder="ì˜ˆ: íŠ¹ì • í¬ê·€ì§ˆí™˜ ë“±">
        <div class="pager"><div class="meta">ì§ˆë¬¸ 4 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- PERSONAL HISTORY -->
      <div class="question" data-step="4" id="step4">
        <label class="block">ë³¸ì¸ ë³‘ë ¥(ê³¼ê±°/í˜„ì¬) â€” í•´ë‹¹ ì‹œ ì²´í¬ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥). ê° í•­ëª©ì—ì„œ ì‹¬ê°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</label>

        <div style="margin-bottom:10px">
          <label><input type="checkbox" name="history" value="diabetes"> ë‹¹ë‡¨</label>
          <span class="severity small">ì‹¬ê°ë„:
            <label class="small"><input type="checkbox" name="sev_diabetes" value="mild" onchange="onlyOne('sev_diabetes', this)"> ê²½ì¦</label>
            <label class="small"><input type="checkbox" name="sev_diabetes" value="mod" onchange="onlyOne('sev_diabetes', this)"> ì¤‘ë“±ë„</label>
            <label class="small"><input type="checkbox" name="sev_diabetes" value="severe" onchange="onlyOne('sev_diabetes', this)"> ì¤‘ì¦</label>
          </span>
        </div>

        <div style="margin-bottom:10px">
          <label><input type="checkbox" name="history" value="hypertension"> ê³ í˜ˆì••</label>
          <span class="severity small">ì‹¬ê°ë„:
            <label class="small"><input type="checkbox" name="sev_hypertension" value="mild" onchange="onlyOne('sev_hypertension', this)"> ê²½ì¦</label>
            <label class="small"><input type="checkbox" name="sev_hypertension" value="mod" onchange="onlyOne('sev_hypertension', this)"> ì¤‘ë“±ë„</label>
            <label class="small"><input type="checkbox" name="sev_hypertension" value="severe" onchange="onlyOne('sev_hypertension', this)"> ì¤‘ì¦</label>
          </span>
        </div>

        <div style="margin-bottom:10px">
          <label><input type="checkbox" name="history" value="dyslipidemia"> ê³ ì§€í˜ˆì¦</label>
          <span class="severity small">ì‹¬ê°ë„:
            <label class="small"><input type="checkbox" name="sev_dyslipidemia" value="mild" onchange="onlyOne('sev_dyslipidemia', this)"> ê²½ì¦</label>
            <label class="small"><input type="checkbox" name="sev_dyslipidemia" value="mod" onchange="onlyOne('sev_dyslipidemia', this)"> ì¤‘ë“±ë„</label>
            <label class="small"><input type="checkbox" name="sev_dyslipidemia" value="severe" onchange="onlyOne('sev_dyslipidemia', this)"> ì¤‘ì¦</label>
          </span>
        </div>

        <div style="margin-bottom:10px">
          <label><input type="checkbox" name="history" value="cvd"> ì‹¬í˜ˆê´€ì§ˆí™˜(ì‹¬ê·¼ê²½ìƒ‰/ë‡Œì¡¸ì¤‘)</label>
          <span class="severity small">ì‹¬ê°ë„:
            <label class="small"><input type="checkbox" name="sev_cvd" value="mild" onchange="onlyOne('sev_cvd', this)"> ê²½ì¦</label>
            <label class="small"><input type="checkbox" name="sev_cvd" value="mod" onchange="onlyOne('sev_cvd', this)"> ì¤‘ë“±ë„</label>
            <label class="small"><input type="checkbox" name="sev_cvd" value="severe" onchange="onlyOne('sev_cvd', this)"> ì¤‘ì¦</label>
          </span>
        </div>

        <div style="margin-bottom:10px">
          <label><input type="checkbox" name="history" value="cancer"> ì•”</label>
          <span class="severity small">ì‹¬ê°ë„:
            <label class="small"><input type="checkbox" name="sev_cancer" value="mild" onchange="onlyOne('sev_cancer', this)"> ê²½ì¦</label>
            <label class="small"><input type="checkbox" name="sev_cancer" value="mod" onchange="onlyOne('sev_cancer', this)"> ì¤‘ë“±ë„</label>
            <label class="small"><input type="checkbox" name="sev_cancer" value="severe" onchange="onlyOne('sev_cancer', this)"> ì¤‘ì¦</label>
          </span>
        </div>

        <div style="margin-bottom:6px"><label><input type="checkbox" name="history" value="none"> í•´ë‹¹ ì—†ìŒ</label></div>

        <label class="block">ê¸°íƒ€ (ì„ íƒ)</label><input type="text" id="history_other" placeholder="ì˜ˆ: ìˆ˜ìˆ ë ¥, ë§Œì„±ì§ˆí™˜ ë“±">
        <div class="pager"><div class="meta">ì§ˆë¬¸ 5 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- SMOKING -->
      <div class="question" data-step="5" id="step5">
        <label class="block">í¡ì—°ìƒíƒœ <span class="small">(í•„ìˆ˜)</span></label>
        <select id="smoke_status" onchange="updateSmokeDetails()">
          <option value="">ì„ íƒ</option><option value="never">ë¹„í¡ì—°</option><option value="former">ê³¼ê±° í¡ì—°</option><option value="current">í˜„ì¬ í¡ì—°</option>
        </select>
        <div id="smoke_details" style="margin-top:12px;display:none">
          <label class="block">í¡ì—° ì¢…ë¥˜ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
          <div class="checkbox-row">
            <label class="checkbtn"><input type="checkbox" id="smoke_cig"> ì¼ë°˜ë‹´ë°°(ì—°ì´ˆ)</label>
            <label class="checkbtn"><input type="checkbox" id="smoke_elec"> ì „ìë‹´ë°°(ì•¡ìƒ/ê°€ì—´ë‹´ë°°)</label>
            <label class="checkbtn"><input type="checkbox" id="smoke_huk"> ê¶ë ¨í˜• ì „ìë‹´ë°°</label>
          </div>

          <label class="block">í¡ì—° ê¸°ê°„</label>
          <select id="smoke_duration"><option value="0">6ê°œì›” ë¯¸ë§Œ</option><option value="1">6ê°œì›”~1ë…„</option><option value="2">1ë…„~3ë…„</option><option value="3">3ë…„~5ë…„</option><option value="4">5ë…„ ì´ìƒ</option></select>

          <label class="block">ì¼ì¼ í¡ì—°ëŸ‰(ë˜ëŠ” ì¹´íŠ¸ë¦¬ì§€/ë³‘ ìˆ˜)</label>
          <select id="smoke_amount"><option value="0">ì ìŒ (ì˜ˆ:<5/ì¼)</option><option value="1">ë³´í†µ (5~15/ì¼)</option><option value="2">ë§ìŒ (16+/ì¼)</option></select>

          <label class="block small">(ê³¼ê±° í¡ì—°ì) ê³¼ê±° í‰ê·  í¡ì—°ëŸ‰</label>
          <select id="smoke_past_amount"><option value="0">í•´ë‹¹ì—†ìŒ/ê¸°ì–µì•ˆë‚¨</option><option value="1">ì ìŒ</option><option value="2">ë³´í†µ</option><option value="3">ë§ìŒ</option></select>
        </div>

        <div class="invalid-note" id="note-step5" style="display:none">í¡ì—° ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        <div class="pager"><div class="meta">ì§ˆë¬¸ 6 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- ALCOHOL -->
      <div class="question" data-step="6" id="step6">
        <label class="block">ìŒì£¼ ë¹ˆë„ (ì§€ë‚œ 1ê°œì›” ê¸°ì¤€) <span class="small">(í•„ìˆ˜)</span></label>
        <select id="alcohol_freq" onchange="updateDrinkDetails()"><option value="0">ì „í˜€ ë§ˆì‹œì§€ ì•ŠìŒ</option><option value="1">ì›” 1~3íšŒ</option><option value="2">ì£¼ 1~2íšŒ</option><option value="3">ì£¼ 3íšŒ ì´ìƒ</option></select>
        <div id="drink_details" style="display:none;margin-top:10px">
          <label class="block">í•œ ë²ˆì— ë§ˆì‹œëŠ” ì–‘ (ì†Œì£¼ ê¸°ì¤€)</label>
          <select id="alcohol_amount"><option value="0">1ë³‘ ë¯¸ë§Œ</option><option value="1">1~2ë³‘</option><option value="2">2ë³‘ ì´ìƒ</option></select>
          <label class="block">í­ìŒ(í•œ ë²ˆì— ê³¼ë‹¤ ì„­ì·¨) ê²½í—˜(ì§€ë‚œ 1ê°œì›”)</label>
          <select id="binge"><option value="0">ì—†ìŒ</option><option value="1">1íšŒ</option><option value="2">2~3íšŒ</option><option value="3">4íšŒ ì´ìƒ</option></select>
        </div>
        <div class="pager"><div class="meta">ì§ˆë¬¸ 7 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- PHYSICAL ACTIVITY -->
      <div class="question" data-step="7" id="step7">
        <label class="block">ì£¼ë‹¹ ì¤‘ë“±ë„ ì´ìƒ ì‹ ì²´í™œë™(ìš´ë™) ì‹œê°„</label>
        <select id="physical_minutes"><option value="0">0ë¶„</option><option value="1">1~60ë¶„</option><option value="2">61~150ë¶„</option><option value="3">151ë¶„ ì´ìƒ</option></select>
        <label class="block">ì£¼ë‹¹ ê·¼ë ¥ìš´ë™ íšŸìˆ˜</label>
        <select id="strength_days"><option value="0">0íšŒ</option><option value="1">1íšŒ</option><option value="2">2íšŒ</option><option value="3">3íšŒ ì´ìƒ</option></select>
        <div class="pager"><div class="meta">ì§ˆë¬¸ 8 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- DIET DETAILS -->
      <div class="question" data-step="8" id="step8">
        <label class="block">ë¬¼ ì„­ì·¨ëŸ‰(í•˜ë£¨)</label>
        <select id="water_intake"><option value="0">500ml ë¯¸ë§Œ</option><option value="1">500ml~1L</option><option value="2">1~2L</option><option value="3">2L ì´ìƒ</option></select>

        <label class="block">ê°€ê³µì‹(ì¸ìŠ¤í„´íŠ¸/íŒ¨ìŠ¤íŠ¸í‘¸ë“œ) ì£¼ê°„ ì„­ì·¨ ë¹ˆë„</label>
        <select id="instant_freq"><option value="3">ê±°ì˜ ì•ˆ ë¨¹ìŒ</option><option value="2">ì£¼ 1~2íšŒ</option><option value="1">ì£¼ 3~4íšŒ</option><option value="0">ì£¼ 5íšŒ ì´ìƒ</option></select>

        <label class="block">ì±„ì†Œ/ê³¼ì¼ ì„­ì·¨ íšŸìˆ˜(í•˜ë£¨)</label>
        <select id="veg_freq"><option value="0">ê±°ì˜ ì•ˆ ë¨¹ìŒ</option><option value="1">1íšŒ ë¯¸ë§Œ</option><option value="2">1~2íšŒ</option><option value="3">3íšŒ ì´ìƒ</option></select>

        <label class="block">ì •í¬/ë‹¹ ì„­ì·¨ ìˆ˜ì¤€(ì£¼ê´€ì )</label>
        <select id="sugar"><option value="3">ê±°ì˜ ì—†ìŒ</option><option value="2">ì ë‹¹</option><option value="1">ë§ìŒ</option><option value="0">ë§¤ìš° ë§ìŒ</option></select>

        <div class="pager"><div class="meta">ì§ˆë¬¸ 9 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- SLEEP & MENTAL -->
      <div class="question" data-step="9" id="step9">
        <label class="block">í‰ê·  ìˆ˜ë©´ì‹œê°„ <span class="small">(í•„ìˆ˜)</span></label>
        <select id="sleep_hours"><option value="0">5ì‹œê°„ ë¯¸ë§Œ</option><option value="1">5~7ì‹œê°„</option><option value="2">7~9ì‹œê°„</option><option value="3">9ì‹œê°„ ì´ìƒ</option></select>

        <label class="block">ìˆ˜ë©´ì˜ ì§ˆ (ì£¼ê´€ì ) <span class="small">(í•„ìˆ˜)</span></label>
        <select id="sleep_quality"><option value="2">ë§¤ìš° ì¢‹ìŒ</option><option value="1">ë³´í†µ</option><option value="0">ë‚˜ì¨</option></select>

        <label class="block">ìµœê·¼ 2ì£¼ê°„ ìš°ìš¸/ìŠ¤íŠ¸ë ˆìŠ¤ ë¹ˆë„ <span class="small">(í•„ìˆ˜)</span></label>
        <select id="mh_stress"><option value="2">ê±°ì˜ ì—†ìŒ</option><option value="1">ê°€ë”</option><option value="0">ìì£¼</option></select>

        <label class="block">ê¸°íƒ€ (ì„ íƒ) â€” ë‹´ë‹¹ì˜ì—ê²Œ ì•Œë¦´ ë§Œí•œ ì¦ìƒ</label>
        <input type="text" id="mh_other" placeholder="ì˜ˆ: ì‹¬í•œ ë¶ˆë©´, ì‹ìš•ìƒì‹¤ ë“±(ì„ íƒ)">

        <div class="invalid-note" id="note-step9" style="display:none">ìˆ˜ë©´Â·ì •ì‹ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        <div class="pager"><div class="meta">ì§ˆë¬¸ 10 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- PREVENTION / SCREENING -->
      <div class="question" data-step="10" id="step10">
        <label class="block">ìµœê·¼ 1ë…„ ë‚´ ì •ê¸°ê²€ì§„ ìˆ˜ê²€ ì—¬ë¶€</label>
        <select id="screening"><option value="1">ì˜ˆ</option><option value="0">ì•„ë‹ˆì˜¤</option></select>

        <label class="block">ê±´ê°•ë³´ì¡°ì œ(ë¹„íƒ€ë¯¼ ë“±) ë³µìš© ì¤‘ì…ë‹ˆê¹Œ?</label>
        <select id="supplement" class="small"><option value="0">ì•„ë‹ˆì˜¤</option><option value="1">ì˜ˆ</option></select>

        <div class="pager"><div class="meta">ì§ˆë¬¸ 11 / 11</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="nextStep()">ë‹¤ìŒ</button></div></div>
      </div>

      <!-- FINAL CONFIRM -->
      <div class="question" data-step="11" id="step11">
        <label class="block">í™•ì¸ í›„ ìš”ì•½ ë³´ê¸°</label>
        <div class="small">ëª¨ë“  ë¬¸í•­ì„ í™•ì¸í•˜ì„¸ìš”. ì œì¶œí•˜ë©´ ìš”ì•½ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.</div>
        <div class="pager"><div class="meta">ìµœì¢… ì ê²€</div><div><button class="btn secondary no-print" type="button" onclick="prevStep()">ì´ì „</button><button class="btn no-print" type="button" onclick="computeAndShowSummary()">ìš”ì•½ ë³´ê¸°</button></div></div>
      </div>

    </form>
  </section>

  <!-- SUMMARY CARD -->
  <section id="summaryCard" class="card" style="display:none">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div>
        <div style="font-size:18px;font-weight:900;color:var(--navy)" id="summaryTitle">ìš”ì•½ â€” OOOë‹˜ì˜ ê±´ê°•</div>
        <div id="summaryText" class="small" style="margin-top:8px"></div>
      </div>
      <div style="text-align:right">
        <div class="mascot" id="mascotLarge" style="width:92px;height:92px;border-radius:14px;background:#fff;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(2,8,23,0.18)">
          <!-- larger cuter rabbit -->
          <svg id="mascotLargeSvg" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="rabbit-large">
            <rect width="128" height="128" rx="18" fill="#fff"/>
            <ellipse cx="64" cy="78" rx="42" ry="32" fill="#fff" stroke="#0b2340" stroke-width="2"/>
            <circle cx="52" cy="68" r="6.5" fill="#0b2340"/>
            <circle cx="76" cy="68" r="6.5" fill="#0b2340"/>
            <circle cx="44" cy="76" r="4.5" fill="#ffdede" opacity="0.95"/>
            <circle cx="84" cy="76" r="4.5" fill="#ffdede" opacity="0.95"/>
            <path id="bunnyLargeMouth" d="M56 92 q14 14 36 0" stroke="#0b2340" stroke-width="3" fill="none" stroke-linecap="round"/>
            <path d="M48 36 q12 -36 32 0 q20 -36 32 0" fill="#fff" stroke="#0b2340" stroke-width="1"/>
          </svg>
        </div>
        <div class="mascotCaption" style="margin-top:10px">í† ë¼ê°€ ê²°ê³¼ì— ë”°ë¼ í‘œì •ì„ ë°”ê¿‰ë‹ˆë‹¤ ğŸ°</div>
        <div style="margin-top:8px"><button class="btn no-print" id="viewReportBtn">ìì„¸íˆ ë³´ê¸°</button> <button class="btn secondary no-print" onclick="saveSummaryToHistory()">íˆìŠ¤í† ë¦¬ ì €ì¥</button></div>
      </div>
    </div>

    <div style="margin-top:14px"><canvas id="summaryChart" width="600" height="260"></canvas></div>

    <div style="margin-top:12px" id="summaryItems"></div>
    <footer class="footer-note">ì§§ì€ ìš”ì•½ì…ë‹ˆë‹¤ â€” ìì„¸í•œ ê¶Œê³ ëŠ” 'ìì„¸íˆ ë³´ê¸°'ë¥¼ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”.</footer>
  </section>

  <!-- DETAILED REPORT -->
  <section id="reportCard" class="card" style="display:none">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div>
        <div style="font-size:18px;font-weight:900;color:var(--navy)" id="reportTitle">ìƒì„¸ ë¦¬í¬íŠ¸</div>
        <div id="reportSubtitle" class="small" style="margin-top:6px"></div>
      </div>
      <div style="text-align:right">
        <button class="btn no-print" onclick="downloadPDF()">PDF ì €ì¥</button>
        <button class="btn secondary no-print" onclick="toggleHistory()">íˆìŠ¤í† ë¦¬</button>
      </div>
    </div>

    <div style="margin-top:12px" class="report-wrap"><canvas id="radarChart" width="600" height="300"></canvas></div>
    <div id="detailList" style="margin-top:12px"></div>
    <div id="planSection" style="display:none;margin-top:12px" class="card">
      <h3 style="margin:0 0 8px;color:var(--accent)">ğŸ“‹ ê°œì¸ ë§ì¶¤ ê°œì„  í”Œëœ (ì¶”ì²œ 3ê°œì›”)</h3>
      <div id="planContent"></div>
    </div>

    <div id="historyPanel" class="history-panel" style="display:none;margin-top:12px">
      <h4 style="margin:0 0 8px;color:var(--accent)">ğŸ•˜ ì €ì¥ëœ íˆìŠ¤í† ë¦¬</h4>
      <div id="historyList"></div>
      <div style="margin-top:8px;text-align:right"><button class="btn secondary no-print" onclick="clearHistory()">ëª¨ë‘ ì‚­ì œ</button></div>
    </div>

    <footer class="footer-note">
      ì¶œì²˜ ìš”ì•½: WHO / CDC / KDCA / Framingham / ëŒ€í•œë¹„ë§Œí•™íšŒ ì™¸ ì£¼ìš” ë©”íƒ€ë¶„ì„ ë…¼ë¬¸ë“¤. ì´ ë„êµ¬ëŠ” ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </footer>
  </section>

</div>

<script>
/* ====== Pager control + validation + enter-key navigation ====== */
const steps = Array.from(document.querySelectorAll('.question'));
const progressBar = document.getElementById('progressBar');
let stepIndex = 0;
function refreshProgress(){ const pct = Math.round(((stepIndex+1)/steps.length)*100); progressBar.style.width = pct + '%'; }
function showStep(i){ steps.forEach((s,idx)=> s.classList.toggle('active', idx===i)); stepIndex=i; refreshProgress(); window.scrollTo({top:0,behavior:'smooth'}); }
showStep(0);

/* Required fields per step (IDs) */
const requiredFields = {
  0: ['name'],
  1: ['age','gender'],
  2: ['height','weight'],
  5: ['smoke_status'],
  6: ['alcohol_freq'],
  9: ['sleep_hours','sleep_quality','mh_stress'],
};

/* utility */
function q(id){ return document.getElementById(id); }
function qa(sel){ return Array.from(document.querySelectorAll(sel)); }

/* clear invalid visuals */
function clearInvalidForStep(i){
  const note = q(`note-step${i}`);
  if(note) note.style.display='none';
  const step = steps[i];
  if(!step) return;
  const inputs = step.querySelectorAll('input,select,textarea');
  inputs.forEach(inp=> inp.classList.remove('invalid'));
}

/* validate current step before moving on. returns true if ok */
function validateStep(i){
  clearInvalidForStep(i);
  const req = requiredFields[i];
  if(!req) return true;
  let ok = true;
  req.forEach(id=>{
    const el = q(id);
    if(!el) return;
    const val = (el.value || '').toString().trim();
    const isEmpty = (val === '' || val === 'null');
    if(isEmpty){
      ok = false;
      el.classList.add('invalid');
    } else {
      // additional numeric checks
      if(id === 'age'){
        const n = Number(val);
        if(isNaN(n) || n < 10 || n > 120){ ok = false; el.classList.add('invalid'); }
      }
      if(id === 'height' || id === 'weight'){
        const n = Number(val);
        if(isNaN(n) || n <= 0){ ok = false; el.classList.add('invalid'); }
      }
    }
  });
  if(!ok){
    const note = q(`note-step${i}`);
    if(note) note.style.display='block';
    return false;
  }
  return true;
}

function nextStep(){
  // validate current
  if(!validateStep(stepIndex)) return;
  if(stepIndex < steps.length-1) showStep(stepIndex+1);
}
function prevStep(){ if(stepIndex > 0) showStep(stepIndex-1); }

/* handle ENTER key navigation - Enter -> next (except textareas where Shift+Enter allowed) */
function setupEnterNavigation(){
  const interactive = document.querySelectorAll('input, select, textarea');
  interactive.forEach(el=>{
    el.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        // textarea allow Shift+Enter for newline
        if(el.tagName.toLowerCase() === 'textarea' && e.shiftKey) return;
        e.preventDefault();
        // if current element belongs to a step, validate that step
        nextStep();
      }
    });
  });
}
setupEnterNavigation();

/* custom checkbtn toggles */
document.querySelectorAll('.checkbtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const inp = btn.querySelector('input');
    if(!inp) return;
    inp.checked = !inp.checked;
    btn.classList.toggle('active', inp.checked);
    // family 'none' exclusive behavior
    if(inp.name==='family'){
      if(inp.value==='none' && inp.checked){
        document.querySelectorAll('input[name="family"]').forEach(i=>{
          if(i.value!=='none'){ i.checked=false; if(i.closest('.checkbtn')) i.closest('.checkbtn').classList.remove('active'); }
        });
      } else if(inp.value!=='none' && inp.checked){
        const none = document.querySelector('input[name="family"][value="none"]');
        if(none){ none.checked=false; if(none.closest('.checkbtn')) none.closest('.checkbtn').classList.remove('active'); }
      }
    }
  });
});

/* onlyOne severity */
function onlyOne(name, checkbox){ const all = document.querySelectorAll(`input[name="${name}"]`); all.forEach(cb=>{ if(cb!==checkbox) cb.checked=false; }); }

/* dynamic show/hide smoking & drinking details */
function updateSmokeDetails(){ const st=document.getElementById('smoke_status').value; document.getElementById('smoke_details').style.display=(st==='former'||st==='current')?'block':'none'; }
function updateDrinkDetails(){ const f=Number(document.getElementById('alcohol_freq').value||0); document.getElementById('drink_details').style.display=(f>0)?'block':'none'; }

/* BMI calc */
function handleBMIandNext(){ const h=Number(document.getElementById('height').value), w=Number(document.getElementById('weight').value); if(!h||!w){ // show invalid
    q('height').classList.add('invalid'); q('weight').classList.add('invalid'); q('note-step2').style.display='block'; return; } const bmi = +(w/((h/100)**2)); document.getElementById('bmiText').innerText=`ê³„ì‚°ëœ BMI: ${bmi.toFixed(1)} (${bmiCategory(bmi)})`; // clear any invalids
  q('height').classList.remove('invalid'); q('weight').classList.remove('invalid'); q('note-step2').style.display='none'; nextStep(); }
function bmiCategory(bmi){ if(bmi<18.5) return 'ì €ì²´ì¤‘'; if(bmi<23) return 'ì •ìƒ'; if(bmi<25) return 'ê³¼ì²´ì¤‘'; if(bmi<30) return 'ë¹„ë§Œ'; return 'ê³ ë„ë¹„ë§Œ'; }

/* ====== Risk calculation (evidence-aligned weights) ====== */
/* weights consistent with prior design; family weights adjusted by evidence-based risk multipliers */
const W = { bmi:0.11, family:0.12, history:0.13, smoke:0.16, drink:0.09, exercise:0.10, diet:0.15, sleep:0.07, stress:0.07 };

/* compute summary */
let lastResult = null;
function computeAndShowSummary(){
  // final validation of all required steps before computing
  for(const si of Object.keys(requiredFields)){
    if(!validateStep(Number(si))){
      showStep(Number(si)); return;
    }
  }

  const name = (q('name').value || 'ìµëª…').trim();
  const age = Number(q('age').value) || null;
  const gender = q('gender').value || null;

  const r = {};
  r.bmi = computeBMIRisk();
  r.family = computeFamilyRisk(); // 0..1
  r.history = computeHistoryRisk();
  r.smoke = computeSmokingRisk();
  r.drink = computeAlcoholRisk();
  r.exercise = computeExerciseRisk();
  r.diet = computeDietRisk();
  r.sleep = computeSleepRisk();
  r.stress = computeStressRisk();

  let weighted = 0; for(const k in W) weighted += (W[k]||0)*(r[k]||0);
  let score = Math.round((1-weighted)*100); score=Math.max(10,Math.min(100,score)); // floor 10

  const perItemScore = {}; for(const k in r) perItemScore[k]=Math.round((1-r[k])*100);

  // label
  let shortLabel='', shortText='';
  if(score>=90){ shortLabel='ë§¤ìš° ì–‘í˜¸'; shortText=`${name}ë‹˜, ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤. í˜„ì¬ ìŠµê´€ì„ ìœ ì§€í•˜ì„¸ìš”.`; }
  else if(score>=75){ shortLabel='ì–‘í˜¸'; shortText=`${name}ë‹˜, ëŒ€ì²´ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤. ì¼ë¶€ í•­ëª© ê°œì„  ê¶Œì¥.`; }
  else if(score>=50){ shortLabel='ì£¼ì˜'; shortText=`${name}ë‹˜, ìƒí™œìŠµê´€ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.`; }
  else { shortLabel='ê³ ìœ„í—˜'; shortText=`${name}ë‹˜, ìœ„í—˜ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.`; }

  lastResult = { timestamp: Date.now(), name, age, gender, score, perItemScore, r, W };

  // persist last result for quick restore
  try{ localStorage.setItem('lastResult', JSON.stringify(lastResult)); }catch(e){ console.warn('localStorage fail',e); }

  // render summary
  q('summaryTitle').innerText = `ìš”ì•½ â€” ${name}ë‹˜ì˜ ê±´ê°•`;
  q('summaryText').innerText = `${shortLabel} â€¢ ${shortText} (ì´ì : ${score}/100)`;
  renderSummaryChart(perItemScore);
  renderSummaryItems(perItemScore, r);
  updateMascot(score);

  // wire detail
  q('viewReportBtn').onclick = ()=>{ showDetailedReport(lastResult); };

  q('surveyCard').style.display='none';
  q('summaryCard').style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ========== risk functions (with clearer units + documented approximations) ========== */

function computeBMIRisk(){
  const h=Number(q('height').value), w=Number(q('weight').value);
  if(!h||!w) return 0;
  const bmi = w/((h/100)**2);
  if(bmi<18.5) return 0.12;
  if(bmi<23) return 0;
  if(bmi<25) return 0.25;
  if(bmi<30) return 0.55;
  return 0.85;
}
function computeFamilyRisk(){
  const boxes = Array.from(document.querySelectorAll('input[name="family"]'));
  const checked = boxes.filter(b=>b.checked).map(b=>b.value);
  if(checked.length===0) return 0;
  if(checked.includes('none')) return 0;
  let s=0;
  if(checked.includes('chd')) s+=0.28;
  if(checked.includes('stroke')) s+=0.18;
  if(checked.includes('hypertension')) s+=0.12;
  if(checked.includes('hyperlipidemia')) s+=0.10;
  if(checked.includes('diabetes')) s+=0.25;
  if(checked.includes('obesity')) s+=0.12;
  if(checked.includes('colon_cancer')) s+=0.10;
  if(checked.includes('breast_cancer')) s+=0.12;
  if(checked.includes('gastric_cancer')) s+=0.08;
  if(checked.includes('liver_cancer')) s+=0.08;
  if(checked.includes('depression')) s+=0.06;
  if(checked.includes('autoimmune')) s+=0.06;
  return Math.min(0.92, s);
}
function computeHistoryRisk(){
  const boxes = Array.from(document.querySelectorAll('input[name="history"]'));
  const checked = boxes.filter(b=>b.checked).map(b=>b.value);
  if(checked.length===0) return 0;
  if(checked.includes('none')) return 0;
  let s=0;
  function sev(name){
    const nodes = document.querySelectorAll(`input[name="${name}"]`);
    let val = 0;
    nodes.forEach(cb=>{ if(cb.checked){ val = cb.value==='mild'?0.6:(cb.value==='mod'?0.8:1.0); }});
    return val;
  }
  if(checked.includes('cvd')) s+=0.5 * (0.5 + 0.5*sev('sev_cvd'));
  if(checked.includes('diabetes')) s+=0.45 * (0.5 + 0.5*sev('sev_diabetes'));
  if(checked.includes('hypertension')) s+=0.3 * (0.5 + 0.5*sev('sev_hypertension'));
  if(checked.includes('dyslipidemia')) s+=0.25 * (0.5 + 0.5*sev('sev_dyslipidemia'));
  if(checked.includes('cancer')) s+=0.35 * (0.5 + 0.5*sev('sev_cancer'));
  return Math.min(1, s);
}
function computeSmokingRisk(){
  const st=q('smoke_status').value;
  if(!st||st==='never') return 0;
  const cig=q('smoke_cig')?.checked;
  const elec=q('smoke_elec')?.checked;
  const huk=q('smoke_huk')?.checked;
  const dur=Number(q('smoke_duration')?.value||0);
  const amt=Number(q('smoke_amount')?.value||0);
  const past=Number(q('smoke_past_amount')?.value||0);
  if(st==='former') return Math.min(0.6, 0.05 + past*0.12);
  const durYears = [0.25,0.75,2,4,7][dur] || 0;
  const cigs = [3,10,20][amt] || 0;
  const packYears = (cigs/20) * durYears;
  let base = 0.2 + Math.tanh(packYears/10)*0.6;
  let typeFactor = 0.9;
  if(cig) typeFactor = 1.0;
  else if(elec) typeFactor = 0.75;
  if(huk) typeFactor = Math.max(typeFactor,0.85);
  return Math.min(1, base * typeFactor);
}
function computeAlcoholRisk(){
  const freq = Number(q('alcohol_freq')?.value||0);
  const amt = Number(q('alcohol_amount')?.value||0);
  const binge = Number(q('binge')?.value||0);
  if(freq===0) return 0;
  const occPerWeek = [0, 0.25, 1.5, 4][freq];
  const bottles = [0.5, 1.5, 2.5][amt] || 0.5;
  const weeklyEthanol = occPerWeek * bottles * 63;
  const normalized = Math.min(1, weeklyEthanol / 140);
  const bingeFactor = Math.min(1, binge/3);
  const risk = 0.55 * normalized + 0.25 * bingeFactor;
  return Math.min(0.92, risk);
}
function computeExerciseRisk(){
  const mins = Number(q('physical_minutes')?.value||0);
  const strength = Number(q('strength_days')?.value||0);
  if(mins>=3 && strength>=2) return 0;
  if(mins>=2) return 0.10;
  if(mins>=1) return 0.25;
  return 0.55;
}
function computeDietRisk(){
  const w = Number(q('water_intake')?.value||0);
  const i = Number(q('instant_freq')?.value||0);
  const v = Number(q('veg_freq')?.value||0);
  const s = Number(q('sugar')?.value||0);
  const waterRisk = (3-w)/3;
  const instantRisk = (3-i)/3;
  const vegRisk = (3-v)/3;
  const sugarRisk = (3-s)/3;
  const risk = 0.35*instantRisk + 0.25*vegRisk + 0.2*sugarRisk + 0.2*waterRisk;
  return Math.min(1, risk);
}
function computeSleepRisk(){
  const hr = Number(q('sleep_hours')?.value||0);
  const qv = Number(q('sleep_quality')?.value||0);
  if(hr===2 && qv===2) return 0;
  let base = (hr===1?0.13:(hr===0?0.35:0.13));
  const qual = (qv===2?0:(qv===1?0.12:0.30));
  return Math.min(1, base + qual);
}
function computeStressRisk(){
  const s = Number(q('mh_stress')?.value||0);
  return (2-s)/2;
}

/* ===== Summary rendering (charts) ===== */
let summaryChart = null;
function renderSummaryChart(perItemScore){
  const labels = ['BMI','ê°€ì¡±ë ¥','ë³‘ë ¥','í¡ì—°','ìŒì£¼','ìš´ë™','ì‹ìŠµê´€','ìˆ˜ë©´','ì •ì‹ ê±´ê°•'];
  const data = [ perItemScore.bmi, perItemScore.family, perItemScore.history, perItemScore.smoke, perItemScore.drink, perItemScore.exercise, perItemScore.diet, perItemScore.sleep, perItemScore.stress ];
  const ctx = document.getElementById('summaryChart').getContext('2d');
  if(summaryChart) summaryChart.destroy();
  summaryChart = new Chart(ctx, {
    type:'radar',
    data:{ labels, datasets:[{ label:'ìš”ì•½ ì ìˆ˜', data, backgroundColor:'rgba(15,76,129,0.16)', borderColor:'#0f4c81', pointBackgroundColor:'#154a7a' }]},
    options:{ scales:{r:{min:0,max:100,ticks:{stepSize:20},grid:{color:'#eef6ff'}}}, plugins:{legend:{display:false}} }
  });
}
function renderSummaryItems(perItemScore, r){
  const container = document.getElementById('summaryItems'); container.innerHTML = '';
  const shortMap = { bmi: 'BMI', family:'ê°€ì¡±ë ¥', history:'ê¸°ì €ì§ˆí™˜', smoke:'í¡ì—°', drink:'ìŒì£¼', exercise:'ìš´ë™', diet:'ì‹ìŠµê´€', sleep:'ìˆ˜ë©´', stress:'ì •ì‹ ê±´ê°•' };
  for(const k in perItemScore){
    const score = perItemScore[k];
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='8px 6px'; el.style.borderBottom='1px solid #f1f6fb';
    el.innerHTML = `<div style="font-weight:700">${shortMap[k]||k}</div><div>${score} / 100</div>`;
    container.appendChild(el);
  }
}

/* ========== Detailed report ========== */
let radarChart = null;
function showDetailedReport(result){
  document.getElementById('summaryCard').style.display='none';
  document.getElementById('reportCard').style.display='block';
  document.getElementById('reportTitle').innerText = `${result.name}ë‹˜ì˜ ìƒì„¸ ë¦¬í¬íŠ¸`;
  document.getElementById('reportSubtitle').innerText = `ìƒì„±ì¼: ${new Date(result.timestamp).toLocaleString()} â€¢ ì´ì : ${result.score}/100`;

  const perItemScore = result.perItemScore;
  const labels = ['BMI','ê°€ì¡±ë ¥','ë³‘ë ¥','í¡ì—°','ìŒì£¼','ìš´ë™','ì‹ìŠµê´€','ìˆ˜ë©´','ì •ì‹ ê±´ê°•'];
  const data = [perItemScore.bmi, perItemScore.family, perItemScore.history, perItemScore.smoke, perItemScore.drink, perItemScore.exercise, perItemScore.diet, perItemScore.sleep, perItemScore.stress];
  const ctx = document.getElementById('radarChart').getContext('2d');
  if(radarChart) radarChart.destroy();
  radarChart = new Chart(ctx, { type:'radar', data:{ labels, datasets:[{ label:'í•­ëª©ë³„ ì ìˆ˜', data, backgroundColor:'rgba(15,76,129,0.16)', borderColor:'#0f4c81', pointBackgroundColor:'#154a7a' }]}, options:{ scales:{r:{min:0,max:100,ticks:{stepSize:20}}}, plugins:{legend:{display:false}} } });

  renderDetails(result.perItemScore, result.r, {name:result.name, age:result.age, gender:result.gender});
  generatePlan(result.perItemScore, result.r, {name:result.name, age:result.age, gender:result.gender});
  window.scrollTo({top:0,behavior:'smooth'});
}

/* render details & plan */
function renderDetails(perItemScore, r, ctxInfo){
  const container = document.getElementById('detailList'); container.innerHTML = '';
  function card(title,score,risk,advice,note=''){
    const wrapper = document.createElement('div'); wrapper.className='detail-card'; wrapper.style.borderLeft=`4px solid ${determineColor(score)}`;
    wrapper.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong style="color:var(--navy)">${title}</strong><span style="font-weight:800">${score} / 100</span></div><div style="height:8px;background:#eef6ff;border-radius:6px;margin:8px 0;overflow:hidden"><div style="width:${score}%;height:100%;background:linear-gradient(90deg,#0f4c81,#0b2340)"></div></div><div style="color:#445">${advice}</div>${note?`<div style="margin-top:8px;font-size:13px;color:var(--muted)">${note}</div>`:''}`;
    container.appendChild(wrapper);
  }
  let bmiAdvice = '';
  if(r.bmi === 0) bmiAdvice = 'BMI ì •ìƒ ë²”ì£¼ì…ë‹ˆë‹¤. ê·œì¹™ì  ì‹ì‚¬Â·ìš´ë™ì„ ìœ ì§€í•˜ì„¸ìš”.';
  else if(r.bmi <= 0.25) bmiAdvice = 'ê³¼ì²´ì¤‘ ì´ˆê¸°: ì‹ë‹¨ ì¡°ì ˆ ë° í™œë™ëŸ‰ ì¦ëŒ€ ê¶Œì¥.';
  else if(r.bmi <= 0.55) bmiAdvice = 'ë¹„ë§Œ ë²”ì£¼: ì²´ì¤‘ 5~10% ê°ëŸ‰ ëª©í‘œ ê¶Œì¥.';
  else bmiAdvice = 'ê³ ìœ„í—˜(ê³ ë„ë¹„ë§Œ): ì „ë¬¸ì˜ ìƒë‹´ ê¶Œì¥.';
  card('ì²´ì§ˆëŸ‰ì§€ìˆ˜ (BMI)', perItemScore.bmi, r.bmi, bmiAdvice, 'ê·¼ê±°: ì•„ì‹œì•„ BMI ì»·ì˜¤í”„ (KDCA/ëŒ€í•œë¹„ë§Œí•™íšŒ).');

  card('ê°€ì¡±ë ¥', perItemScore.family, r.family, r.family===0?'ê°€ì¡±ë ¥ ì—†ìŒ. ì¼ë°˜ ê²€ì§„ ê¶Œì¥.':'ê°€ì¡±ë ¥ ì¡´ì¬: ì¡°ê¸°ê²€ì§„ ê³ ë ¤ ë° ìœ„í—˜ìš”ì¸ ê´€ë¦¬ ê¶Œì¥.');

  card('ê¸°ì €ì§ˆí™˜', perItemScore.history, r.history, r.history===0?'ê¸°ì €ì§ˆí™˜ ì—†ìŒ.':'ê¸°ì €ì§ˆí™˜ ì¡´ì¬: ì§€ì†ì ì¸ ì¹˜ë£ŒÂ·ì¶”ì  í•„ìš”.');

  const smStatus = q('smoke_status').value;
  let smokeAdvice = '';
  if(smStatus===''||smStatus==='never') smokeAdvice='ë¹„í¡ì—° ìƒíƒœì…ë‹ˆë‹¤. ê°„ì ‘í¡ì—° íšŒí”¼ ê¶Œì¥.';
  else if(smStatus==='former') smokeAdvice='ê³¼ê±° í¡ì—°ë ¥ ìˆìŒ: ê¸ˆì—° ìœ ì§€ ë° ê²€ì§„ ê¶Œì¥.';
  else smokeAdvice='í˜„ì¬ í¡ì—°ì: ê¸ˆì—°ì´ ê°€ì¥ ê°•ë ¥í•œ ìœ„í—˜ê°ì†Œ ìˆ˜ë‹¨ì…ë‹ˆë‹¤.';
  card('í¡ì—°(ì¼ë°˜/ì „ì)', perItemScore.smoke, r.smoke, smokeAdvice, 'ê·¼ê±°: WHO/CDC â€” ì „ìë‹´ë°°ë„ íÂ·ì‹¬í˜ˆê´€ ì˜í–¥ ë³´ê³ .');

  const af = Number(q('alcohol_freq')?.value||0);
  let drinkAdvice = af===0?'ìŒì£¼ ì—†ìŒ':'ì ˆì£¼ ê¶Œì¥: ì£¼ê°„ ìŒì£¼ëŸ‰ ê°ì¶• ì‹œ ìœ„í—˜ ê°ì†Œ.';
  card('ìŒì£¼', perItemScore.drink, r.drink, drinkAdvice);

  const exv = Number(q('physical_minutes')?.value||0);
  const exAdvice = exv>=3?'ìš´ë™ëŸ‰ ì–‘í˜¸: í˜„ì¬ ë£¨í‹´ ìœ ì§€.':'ìš´ë™ëŸ‰ ì¦ê°€ ê¶Œì¥: ì£¼ 150ë¶„ ì¤‘ë“±ë„ ëª©í‘œ.';
  card('ì‹ ì²´í™œë™', perItemScore.exercise, r.exercise, exAdvice, 'ê·¼ê±°: WHO ì‹ ì²´í™œë™ ê¶Œê³ .');

  card('ì‹ìŠµê´€', perItemScore.diet, r.diet, 'ì±„ì†ŒÂ·ê³¼ì¼ ì„­ì·¨ ì¦ê°€, ê°€ê³µì‹Â·ë‹¹ë¥˜ ì œí•œ ê¶Œì¥.');

  card('ìˆ˜ë©´', perItemScore.sleep, r.sleep, r.sleep===0?'ìˆ˜ë©´ ì–‘í˜¸':'ìˆ˜ë©´ ìœ„ìƒ ê°œì„  ê¶Œì¥ (ì·¨ì¹¨ ë£¨í‹´, ì „ìê¸°ê¸° ì œí•œ).');

  const stv = Number(q('mh_stress')?.value||2);
  card('ì •ì‹ ê±´ê°•', perItemScore.stress, r.stress, stv===2?'ìŠ¤íŠ¸ë ˆìŠ¤ ì–‘í˜¸':'ì •ê¸°ì  ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ ê¶Œì¥.');
}

function determineColor(score){
  if(score>=80) return getComputedStyle(document.documentElement).getPropertyValue('--good')||'#1fbf7b';
  if(score>=60) return getComputedStyle(document.documentElement).getPropertyValue('--warn')||'#f6c85f';
  return getComputedStyle(document.documentElement).getPropertyValue('--bad')||'#ef5350';
}

/* plan generator */
function generatePlan(perItemScore, r, ctxInfo){
  document.getElementById('planSection').style.display='block';
  const content = document.getElementById('planContent'); content.innerHTML='';
  function add(title, bullets, note=''){
    const el=document.createElement('div'); el.style.marginBottom='10px';
    const h=document.createElement('div'); h.style.fontWeight='800'; h.style.color='var(--accent)'; h.textContent=title; el.appendChild(h);
    const ul=document.createElement('ul'); ul.style.margin='6px 0 0 18px';
    bullets.forEach(b=>{ const li=document.createElement('li'); li.style.marginBottom='6px'; li.textContent=b; ul.appendChild(li); });
    el.appendChild(ul);
    if(note){ const n=document.createElement('div'); n.className='small'; n.style.marginTop='6px'; n.textContent=note; el.appendChild(n); }
    content.appendChild(el);
  }

  if(r.bmi > 0.25) add('ì²´ì¤‘ê´€ë¦¬(3ê°œì›” ëª©í‘œ)', ['ëª©í‘œ: ì²´ì¤‘ 3~5% ê°ëŸ‰(ì²« 3ê°œì›”)', 'ì‹ì´: í•˜ë£¨ 300kcal ê°ëŸ‰ ëª©í‘œ, ì„¤íƒ•Â·ê°€ê³µì‹ ì œí•œ', 'ìš´ë™: ì£¼ 150ë¶„ ìœ ì‚°ì†Œ + ì£¼ 2íšŒ ê·¼ë ¥'], 'ê·¼ê±°: ì²´ì¤‘ 5% ê°ëŸ‰ì˜ ëŒ€ì‚¬ê°œì„  íš¨ê³¼ ë³´ê³ ');
  else add('ì²´ì¤‘ê´€ë¦¬', ['í˜„ì¬ BMI ì–‘í˜¸: ê· í˜•ì‹Â·ê·œì¹™ì  ìš´ë™ ìœ ì§€']);

  if(r.smoke > 0.2) add('ê¸ˆì—° í”Œëœ', ['ê¸ˆì—°ì¼ ì„¤ì •', 'ë‹ˆì½”í‹´ ëŒ€ì²´ìš”ë²•/í´ë¦¬ë‹‰ í™œìš©', 'ëŒ€ì²´í–‰ë™(ë¬¼, ê»Œ, ì‹¬í˜¸í¡) ì ìš©', 'ì¬ë°œ ì‹œ ì „ë¬¸ìƒë‹´'], 'ê·¼ê±°: ê¸ˆì—° ì‹œ ì‹¬í˜ˆê´€Â·ì•” ìœ„í—˜ ê°ì†Œ');
  else add('í¡ì—°', ['ë¹„í¡ì—° ìœ ì§€']);

  if(r.drink > 0.2) add('ì ˆì£¼ í”Œëœ', ['ì£¼ 2ì¼ ì´ìƒ ê¸ˆì£¼ ìˆ˜ë¦½', 'ìŒì£¼ ìœ ë°œ í™˜ê²½ ê´€ë¦¬', 'ìŒì£¼ì¼ì§€ ê¸°ë¡'], 'ê·¼ê±°: ëˆ„ì  ìŒì£¼ëŸ‰ ê°ì†Œ ì‹œ ê°„Â·ì‹¬í˜ˆê´€ ìœ„í—˜ ê°œì„ ');
  else add('ìŒì£¼', ['ì ˆì£¼ ìœ ì§€']);

  if(r.exercise > 0.1) add('ìš´ë™ ì¦ì§„', ['ì£¼ 150ë¶„ ì¤‘ë“±ë„ ë˜ëŠ” 75ë¶„ ê³ ê°•ë„', 'ê·¼ë ¥ìš´ë™ ì£¼ 2íšŒ', 'ì¼ìƒ í™œë™(ê³„ë‹¨, ê±·ê¸°) ì¦ê°€'], 'ê·¼ê±°: WHO ì‹ ì²´í™œë™ ê¶Œê³ ');
  else add('ìš´ë™', ['ë£¨í‹´ ìœ ì§€, ë¶€ì¡± ì‹œ ì ì§„ì  ì¦ê°€']);

  if(r.diet > 0.2) add('ì‹ìŠµê´€ ê°œì„ ', ['ì±„ì†ŒÂ·ê³¼ì¼ í•˜ë£¨ 3íšŒ ì´ìƒ', 'ê°€ê³µì‹ ìµœì†Œí™”', 'ë‹¹ë¥˜ ìŒë£Œ ëŒ€ì²´(ë¬¼Â·ë¬´ê°€ë‹¹ ì°¨)'], 'ê·¼ê±°: ê°€ê³µì‹Â·ë‹¹ë¥˜ ê°ì†ŒëŠ” ëŒ€ì‚¬ ê°œì„ ì— ìœ íš¨');
  else add('ì‹ìŠµê´€', ['ì–‘í˜¸ â€” ìœ ì§€']);

  if(r.sleep > 0.12) add('ìˆ˜ë©´ ê°œì„ ', ['ì·¨ì¹¨/ê¸°ìƒ ì‹œê°„ ê³ ì •', 'ì·¨ì¹¨ 1ì‹œê°„ ì „ ìŠ¤í¬ë¦° ì œí•œ', 'ì¹´í˜ì¸ ì„­ì·¨ ì˜¤í›„ ì œí•œ'], 'ê·¼ê±°: ìˆ˜ë©´ ìœ„ìƒ ê°œì„ ì€ ìˆ˜ë©´ ì§ˆ í–¥ìƒì— ìœ íš¨');
  else add('ìˆ˜ë©´', ['ì–‘í˜¸ â€” ìœ ì§€']);

  if(r.stress > 0.15) add('ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬', ['ë§¤ì¼ 10ë¶„ ë§ˆìŒì±™ê¹€/í˜¸í¡', 'ì£¼ë‹¹ 2~3íšŒ ê²½ë„ ìš´ë™', 'ì§€ì† ì‹œ ì „ë¬¸ ìƒë‹´'], 'ê·¼ê±°: ì •ì‹ ê±´ê°• ì¤‘ì¬ëŠ” ì „ë°˜ì  ìœ„í—˜ ê°ì†Œì— ë„ì›€');
  else add('ì •ì‹ ê±´ê°•', ['ì–‘í˜¸ â€” ìœ ì§€']);
}

/* ===== History (localStorage): save lastResult + archive ===== */
function saveSummaryToHistory(){
  if(!lastResult) return alert('ë¨¼ì € ìš”ì•½ì„ ìƒì„±í•˜ì„¸ìš”.');
  const hist = JSON.parse(localStorage.getItem('healthHistory')||'[]');
  hist.push(lastResult);
  try{ localStorage.setItem('healthHistory', JSON.stringify(hist)); localStorage.setItem('lastResult', JSON.stringify(lastResult)); }
  catch(e){ console.warn('LocalStorage save error', e); alert('ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.'); return; }
  alert('ìš”ì•½ ê²°ê³¼ê°€ íˆìŠ¤í† ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
function toggleHistory(){
  const panel = document.getElementById('historyPanel');
  panel.style.display = (panel.style.display==='none' || panel.style.display==='') ? 'block' : 'none';
  if(panel.style.display==='block') renderHistory();
}
function renderHistory(){
  const list = document.getElementById('historyList'); list.innerHTML='';
  const hist = JSON.parse(localStorage.getItem('healthHistory')||'[]').slice().reverse();
  if(hist.length===0){ list.innerHTML='<div class="small">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  hist.forEach((h,idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 6px'; row.style.borderBottom='1px solid #f1f6fb';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${h.name||'ìµëª…'}</div><div class="small">${new Date(h.timestamp).toLocaleString()}</div><div class="small">ì´ì : ${h.score}</div>`;
    const right = document.createElement('div');
    const loadBtn = document.createElement('button'); loadBtn.className='btn secondary no-print'; loadBtn.style.marginRight='8px'; loadBtn.textContent='ë¶ˆëŸ¬ì˜¤ê¸°';
    loadBtn.onclick = ()=>{ showDetailedReport(h); };
    const delBtn = document.createElement('button'); delBtn.className='btn secondary no-print'; delBtn.textContent='ì‚­ì œ';
    delBtn.onclick = ()=>{ if(confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ removeHistoryEntry(hist.length-1-idx); } };
    right.appendChild(loadBtn); right.appendChild(delBtn);
    row.appendChild(left); row.appendChild(right); list.appendChild(row);
  });
}
function removeHistoryEntry(index){ const all = JSON.parse(localStorage.getItem('healthHistory')||'[]'); all.splice(index,1); localStorage.setItem('healthHistory', JSON.stringify(all)); renderHistory(); }
function clearHistory(){ if(!confirm('íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; localStorage.removeItem('healthHistory'); renderHistory(); }

/* ===== PDF: fix clipping via canvas slicing (improved handling) ===== */
async function downloadPDF(){
  const el = document.getElementById('reportCard');
  // hide non-printable controls
  const controls = document.querySelectorAll('.no-print'); controls.forEach(c=>c.style.display='none');

  // ensure report is fully expanded (history/plan visible)
  document.getElementById('planSection').style.display='block';

  const scale = 2;
  const canvas = await html2canvas(el, {scale:scale, useCORS:true, windowWidth:document.documentElement.scrollWidth, windowHeight:document.documentElement.scrollHeight});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgWidth = pageWidth - 20;
  const imgHeight = canvas.height * imgWidth / canvas.width;
  if(imgHeight <= pageHeight - 20){
    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    pdf.save(`Health_Report_${new Date().toISOString().slice(0,10)}.pdf`);
    controls.forEach(c=>c.style.display='inline-block');
    return;
  }
  const pageHeightPx = Math.floor(canvas.width * (pageHeight - 20) / imgWidth);
  let y = 0;
  while(y < canvas.height){
    const slice = document.createElement('canvas');
    slice.width = canvas.width;
    slice.height = Math.min(pageHeightPx, canvas.height - y);
    const ctx = slice.getContext('2d');
    ctx.drawImage(canvas, 0, y, canvas.width, slice.height, 0, 0, canvas.width, slice.height);
    const sliceData = slice.toDataURL('image/png');
    const sliceImgHeight = slice.height * imgWidth / canvas.width;
    pdf.addImage(sliceData, 'PNG', 10, 10, imgWidth, sliceImgHeight);
    y += pageHeightPx;
    if(y < canvas.height) pdf.addPage();
  }
  pdf.save(`Health_Report_${new Date().toISOString().slice(0,10)}.pdf`);
  controls.forEach(c=>c.style.display='inline-block');
}

/* Mascot update (flat mouth shapes) */
function updateMascot(score){
  const smallMouth = document.getElementById('bunnyMouth');
  const largeMouth = document.getElementById('bunnyLargeMouth');
  const mascotBg = document.getElementById('mascotSmall');
  if(!smallMouth || !largeMouth) return;
  if(score>=75){
    smallMouth.setAttribute('d','M28 44 q4 6 8 0'); // smile
    largeMouth.setAttribute('d','M56 92 q14 14 36 0');
    mascotBg.style.background = '#ffffff';
  } else if(score>=50){
    smallMouth.setAttribute('d','M28 44 q4 2 8 0'); // neutral
    largeMouth.setAttribute('d','M56 92 q14 6 36 0');
    mascotBg.style.background = '#fffbe6';
  } else {
    smallMouth.setAttribute('d','M28 46 q4 -4 8 0'); // worried
    largeMouth.setAttribute('d','M56 92 q14 -6 36 0');
    mascotBg.style.background = '#fff0f0';
  }
}

/* init: read last result existence (do not auto-show) */
(function init(){
  try{
    const last = JSON.parse(localStorage.getItem('lastResult')||'null');
    if(last) { /* available via history */ }
  }catch(e){}
})();


/* ============================================================
  âœ… (ì¶”ê°€ ê¸°ëŠ¥ 2) ì°¸ì—¬ì ë­í‚¹ (Leaderboard) + ê´€ë¦¬ì ê¸°ëŠ¥ + PDF ìˆ˜ì •
   ============================================================ */

// ğŸ“Œ ë­í‚¹ ì„¹ì…˜ ë™ì  ì¶”ê°€
const rankingSection = document.createElement('section');
rankingSection.id = 'rankingSection';
rankingSection.className = 'card';
rankingSection.style.display = 'none';
rankingSection.innerHTML = `
  <h2>ğŸ† ê±´ê°• ìŠµê´€ ë­í‚¹</h2>
  <p class="small">ì €ì¥ëœ ì°¸ì—¬ìë“¤ì˜ ê±´ê°• ì ìˆ˜ë¥¼ ë¹„êµí•´ë³´ì„¸ìš”.</p>
  <table style="width:100%;border-collapse:collapse;margin-top:10px">
    <thead>
      <tr style="background:#f3f7fe;color:var(--navy)">
        <th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì ìˆ˜</th><th>ë‚ ì§œ</th>
      </tr>
    </thead>
    <tbody id="rankingBody"></tbody>
  </table>
  <div style="text-align:right;margin-top:14px">
    <button class="btn secondary" onclick="backToSummary()">â† ìš”ì•½ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>
`;
document.querySelector('.app').appendChild(rankingSection);

// ğŸ§  ë­í‚¹ ë°ì´í„° ê´€ë¦¬
function updateLeaderboard(name, score) {
  const data = JSON.parse(localStorage.getItem('leaderboard') || '[]');
  data.push({ name, score, time: new Date().toISOString() });
  data.sort((a, b) => b.score - a.score); // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
  const trimmed = data.slice(0, 10); // ìƒìœ„ 10ëª…ë§Œ ìœ ì§€
  localStorage.setItem('leaderboard', JSON.stringify(trimmed));
  return trimmed;
}


// ğŸ–¥ï¸ ë­í‚¹ ë Œë”ë§
function renderLeaderboard(currentName, currentScore) {
  const tbody = document.getElementById('rankingBody');
  const data = JSON.parse(localStorage.getItem('leaderboard') || '[]');
  if (!tbody) return;
  tbody.innerHTML = data.length
    ? data.map((p, i) => `
        <tr ${p.name === currentName && p.score === currentScore ? 'style="background:#e8f3ff;font-weight:700;color:var(--accent)"' : ''}>
          <td>${i + 1}</td>
          <td>${p.name}</td>
          <td>${p.score}</td>
          <td>${new Date(p.time).toLocaleDateString()}</td>
        </tr>
      `).join('')
    : `<tr><td colspan="4" style="text-align:center;padding:10px;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
}


// ğŸ§¾ ìš”ì•½ ìƒì„± í›„ â€œë­í‚¹ ë³´ê¸°â€ ë²„íŠ¼ ì¶”ê°€
const originalCompute = computeAndShowSummary;
computeAndShowSummary = function() {
  originalCompute(); // ê¸°ì¡´ ê¸°ëŠ¥ ì‹¤í–‰

  // [1] 'íˆìŠ¤í† ë¦¬ ì €ì¥' ë²„íŠ¼ ì œê±° (IDê°€ ë‹¬ë¼ë„ í…ìŠ¤íŠ¸ ê¸°ì¤€ìœ¼ë¡œ íƒìƒ‰)
  const buttons = document.querySelectorAll('#summaryCard button');
  buttons.forEach(btn => {
    if (btn.textContent.includes('íˆìŠ¤í† ë¦¬ ì €ì¥')) btn.remove();
  });

  // [2] ë­í‚¹ ë³´ê¸° ë²„íŠ¼ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
  if (!document.getElementById('rankBtn')) {
    const btn = document.createElement('button');
    btn.id = 'rankBtn';
    btn.className = 'btn secondary';
    btn.textContent = 'ğŸ† ë­í‚¹ ë³´ê¸°';
    btn.style.marginTop = '12px';
    btn.onclick = () => {
      updateLeaderboard(lastResult.name, lastResult.score);
      renderLeaderboard(lastResult.name, lastResult.score);
      document.getElementById('summaryCard').style.display = 'none';
      document.getElementById('rankingSection').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    document.getElementById('summaryCard').appendChild(btn);
  }
};



// ğŸ§­ ìš”ì•½ìœ¼ë¡œ ëŒì•„ê°€ê¸°
function backToSummary() {
  document.getElementById('rankingSection').style.display = 'none';
  document.getElementById('summaryCard').style.display = 'block';
}

/* ============================================================
  ğŸ” ê´€ë¦¬ì ëª¨ë“œ ê°„í¸ ì´ˆê¸°í™” (ë²„íŠ¼ ì—†ìŒ, ë­í‚¹ì°½ ìœ ì§€)
   ============================================================ */
const ADMIN_PASS = "ì´ˆê¸°í™”";

window.addEventListener("keydown", (e) => {
  if (e.shiftKey && e.key.toLowerCase() === "m") {
    e.preventDefault();
    const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    if (pw === ADMIN_PASS) {
      if (confirm("âš ï¸ ëª¨ë“  ë­í‚¹ ë° íˆìŠ¤í† ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.removeItem("healthHistory");
        localStorage.removeItem("leaderboard");

        // âœ… ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë©”ì‹œì§€ í‘œì‹œ ë° í™”ë©´ ê°±ì‹ 
        alert("âœ… ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        renderLeaderboard(); // í…Œì´ë¸” ë‚´ìš© ì¦‰ì‹œ ê°±ì‹ 
      }
    } else if (pw !== null) {
      alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  }
});
</script>
</body>
</html>
